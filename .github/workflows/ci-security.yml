name: CI-Sec Frontend

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ───────────────────────────── prepare ─────────────────────────────
  prepare:
    runs-on: [self-hosted, docker]
    defaults:
      run:
        working-directory: pitstop-webapp      # on reste dans le sous-dossier

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node & npm cache
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          # ← chemin RELATIF depuis la racine du dépôt
          cache-dependency-path: pitstop-webapp/package-lock.json

      - name: Install deps
        run: npm ci

  # ───────────────────────────── SAST (Sonar + Semgrep) ──────────────
  sast:
    needs: prepare
    runs-on: [self-hosted, docker]
    if: github.event_name == 'pull_request'        # scanne uniquement les PR
    defaults:
      run:
        working-directory: pitstop-webapp

    steps:
      - uses: actions/checkout@v4

      # ---------- SonarCloud ----------
      - name: Sonar Scan
        uses: sonarsource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: .
          args: >
            -Dsonar.projectKey=pitstop-webapp-hicham
            -Dsonar.organization=hichamben

      # ---------- Semgrep ----------
      - name: Semgrep Scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/react
          generateSarif: true

      # ---------- Bloquer si CVSS ≥ 5 ----------
      - name: Fail if CVSS >=5
        run: |
          n=$(jq '.runs[].results
                  | map(select(.properties.security_severity_level
                               | tonumber >= 5)) | length' semgrep.sarif || echo 0)
          if [ "$n" -gt 0 ]; then
            echo "::error::Critical SAST finding (CVSS >=5)."
            exit 1
          fi


      # ----------  job image-scan ----------    
  image-scan:
    needs: prepare
    runs-on: self-hosted
    steps:
      - uses: docker/build-push-action@v5
        with:
          context: ./pitstop-webapp        # ← adapte 
          tags: ${{ secrets.DOCKER_USERNAME }}/webapp:${{ github.sha }}
          load: true

      - name: Trivy scan
        uses: aquasecurity/trivy-action@v0.11.0
        with:
          image-ref: ${{ secrets.DOCKER_USERNAME }}/webapp:${{ github.sha }}
          severity: CRITICAL,HIGH
          format: table
          output: trivy-report.txt

      - name: Upload Trivy report
        uses: actions/upload-artifact@v3
        with:
          name: trivy-report
          path: trivy-report.txt
          retention-days: 3

      - name: Snyk scan
        uses: snyk/actions/node@v2
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor
